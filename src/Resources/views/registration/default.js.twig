let pushSubscription = window.HuhPwaPushNotificationSubscription;
pushSubscription.subscribePath = '{{ subscribePath }}';
pushSubscription.unsubscribePath = '{{ unsubscribePath }}';

let debug = {% if debug|default(false) %}true{% else %}false{% endif %};

{% if debug|default(false) %}pushSubscription.debug = true;{% endif %}

if (!('serviceWorker' in navigator)) {
    if (debug) {console.log('[SW Registration] Service Worker not supported')};
    document.dispatchEvent(new Event('huh_pwa_sw_not_supported'));
}
else {
    if (debug) console.log("[SW Registration] Register service worker");
    navigator.serviceWorker.register('{{ serviceWorkerPath }}', {
        scope: '/'
    });

    {% if supportPush|default(false) %}
        if (('PushManager' in window)) {
            {% if debug|default(false) %}console.log("[SW Registration] Push supported");{% endif %}

            navigator.serviceWorker.ready
            .then(function(registration) {
                {% if debug|default(false) %}console.log("[SW Registration] Service worker registered");{% endif %}
                return registration.pushManager.getSubscription();
            }).then(function(subscription) {
                if (subscription)
                {
                    {% if debug|default(false) %}console.log('[SW Registration] Already subscribed');{% endif %}
                    pushSubscription.setIsSubscribed();
                }
                else
                {
                    {% if debug|default(false) %}console.log('[SW Registration] Not subscribed');{% endif %}
                    pushSubscription.setIsUnsubscribed();
                }
            });
        }
        else {
            document.dispatchEvent(new Event('huh_pwa_push_not_supported'))
            {% if debug|default(false) %}console.log('[SW Registration] Browser don\'t support push. Hide subscription button.');{% endif %}
        }
    {% endif %}
}

document.addEventListener('DOMContentLoaded', function() {
    pushSubscription.onLoaded();
});